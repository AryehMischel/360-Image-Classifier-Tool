<!DOCTYPE html>
<html>
<!-- <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script> -->
<script src="aframe-master.js"></script>
<script src="aframe-html.js"></script>
<script src="https://unpkg.com/aframe-cubemap-component@2.1.1/dist/aframe-cubemap-component.min.js"></script>
<script src="./aframe-stereocam-component.js"></script>
<script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script>
<script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<link rel="stylesheet" href="styles.css">

<body>
  <a-scene webxr="overlayElement:#dom-overlay;">
    <a-assets>

    </a-assets>

    <!-- <a-box onclick="document.getElementById('imgInput').click()"id="a" position="-1 0.5 -3" rotation="0 45 0" color="red"></a-box> -->

    <a-entity id="user">
      <a-camera stereocam="eye:left;">
        <a-entity id="cursor" class="raycasting" cursor="rayOrigin:mouse" raycaster=""></a-entity>
      </a-camera>
      <a-entity raycaster="objects: .ui" super-hands laser-controls hand-controls="hand: left"></a-entity>
      <a-entity raycaster="objects: .ui" super-hands laser-controls hand-controls="hand: right"></a-entity>
    </a-entity>

    <a-entity id="htmlPanel" shadow position="0.25 1.5 -0.5"></a-entity>

    <!-- default scene -->
    <a-entity id="layers">




    </a-entity>


  </a-scene>
  <!-- style="display: inline-block; background: lavenderblush; color: #333333; border-radius: 1em; padding: 1em; margin:0; accent-color: hotpink;" -->
  <div id="dom-overlay">
    <section id="my-interface">


      <h2>Upload 360 Images</h2>
      <label for="imgInput" class="btn">Select Image Folder</label>
      
      <input class="input" accept="image/png, image/jpeg" style="visibility:hidden;" type="file" id="imgInput"
        webkitdirectory multiple />
        <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  </div>


</body>

</html>

<script src="./generateObjects.js"></script>
<script src="./uicontrols.js"></script>

<script src="./imageHandling.js"></script>





<!-- the point is to accurately classify images as the following 360 formats-->
<!-- cubemaps (6:1, Horizontal Cross, Reverse Horizontal Cross, Vertical Cross, Horizontal Capital T)-->
<!-- stereocubemaps (12:1, ?)-->
<!-- stereoSpherical (Left:Right,Top:Bottom, ?)-->
<!-- -->
<!-- -->

<script>
  const scene = document.querySelector("a-scene")
  var globalImageFiles = new Map()
  var buttonsToEnable = []
  let imagesLoading = 0
  let imagesLoaded = 0






  //img upload

  document.getElementById('imgInput').onchange = async function (e) {
    disableButtonsWaitForSceneLoad() //disable ui 


    var files = $.grep(this.files, function (file) { return file.type.indexOf("image/") === 0; }); // filter out images 
    imagesLoading = files.length
   
   
    let dir = parseDirectoryHierarchy(files)//dir { directory name: imgMap{ imgName: imgFile, etc...}} dir is a map with a nested map -> imgMap


    dir.forEach((values, keys) => {
      let name = keys;

      while (activeButtons.has(name)) {
        name = name + "_"
      }


      if (values.size == 6) { //check if it is a cubemap   //process images //check if images are valid cubemap
        let v = values
       
        try {

          let processedImages = processCubeImages(values)
          let parent = setupCubeMapFolderParent(name)
          processedImages[0].then(() => { createCubeMapFromFolder(processedImages[1], parent) });
          //could be simplified to createCubeMapFromFolder

        } catch {

          checkCubeMapViable(values).then((Values) => { //I should check even if names are correct?
            Values[0].then((values) => {
              if (values == true) {

                //handle -> cubemap input files not specified 
              } else {

                let imagesTO = Values[1];

                for (let i = 0; i < imagesTO.length; i++) {

                  let img = imagesTO[i]

                  while (activeButtons.has(img.name)) {
                    img.name = img.name + "_"

                  }

                  globalImageFiles.set(img.name, v.get(img.name))
                  addButton(setLayer, img.name); // buttonsToEnable.push("button" + img.name); //add button to ui
                  activeButtons.add(img.name)
                  findformat.call(img)

                }

                v = null
              }
            })
          })
        }
      } else {
        values.forEach((values, keys) => {
          processImage(values)
        })
      }
    });

    dir = null
    flatArray = null
    files = null
  }






  //get image dimensions & and match to image format -> then transform image into 3d object
  function findformat() {

    let ratio = Math.round((this.width / this.height) * 10) / 10 // the ratio of the image will indicate the 360 format of the image
    console.log(ratio)
    let parent = document.createElement("a-entity"); //this object will be the parent of any 3d meshes generated from the current image     
    parent.setAttribute("id", this.name)
    layers.appendChild(parent)

    switch (ratio) {
      case 12: watch(this.name, "stereoCube"); createStereoCube(this, parent); break;
      case 6: watch(this.name, "CubeStrip"); processCubeStrip(this, parent); break;
      case 2: watch(this.name, "Sphere"); createSphere(this, parent); break;
      case 1.3: watch(this.name, "t cubemap"); processCubeMap(this, parent); break;
      case 1: watch(this.name, "stereo spherical"); createStereoSphere(this, parent); break;
      default: console.log("NA"); imagesLoading--; if (imagesLoaded == imagesLoading) { setupLayers() }; document.getElementById("label" + this.name).innerHTML = "no format detected"
    }
  }



  function watch(name, label) {
    buttonsToEnable.push("button" + name)
    document.getElementById("label" + name).innerHTML = label

  }
</script>


<script>
  $(function () {
    $("#dom-overlay ").draggable();
  });
  const allEqual = arr => arr.every(val => val === arr[0]);
</script>

<script>



</script>

<script src="./picker.js"></script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>